(()=>{"use strict";const t="https://ytscri.be";function e(){return new URLSearchParams(window.location.search).get("v")}function n(t){chrome.runtime.sendMessage({type:"UPDATE_ICON",success:t})}async function o(){const o=e();if(!o)return;console.log("Processing video:",o);const r=await async function(e){try{const n=await fetch(`${t}/api/videos/${e}/exists`),o=await n.json();return{exists:!0===o.exists,hasTranscript:!0===o.has_transcript}}catch(t){return console.error("Error checking video status:",t),{exists:!1,hasTranscript:!1}}}(o);if(r.exists&&r.hasTranscript)return void console.log("Video already has transcript in database");r.exists&&!r.hasTranscript?console.log("Video exists but missing transcript, fetching..."):console.log("New video, fetching transcript...");const s=function(){try{const t=document.querySelectorAll("script");for(const e of t){const t=e.textContent||"";if(t.includes("ytInitialData")){const e=t.match(/"channelId":"([^"]+)"/);if(e)return e[1]}}}catch(t){console.error("Error extracting channel ID:",t)}return null}();if(!s)return void console.log("Could not extract channel ID");const i=function(t,e){try{const n=document.querySelectorAll("script");for(const o of n){const n=o.textContent||"";if(n.includes("ytInitialPlayerResponse")){const o=n.match(/ytInitialPlayerResponse\s*=\s*({.+?});/);if(o){const n=JSON.parse(o[1]).videoDetails;return{videoId:t,channelId:e,title:n.title,description:n.shortDescription||"",publishedAt:(new Date).toISOString(),thumbnailUrl:n.thumbnail?.thumbnails?.[0]?.url||""}}}}}catch(t){console.error("Error extracting video info:",t)}return null}(o,s);if(!i)return void console.log("Could not extract video info");if(!await async function(){return new Promise(t=>{const e=document.querySelectorAll("button");for(const n of e){const e=n.textContent?.toLowerCase()||"";if(e.includes("show transcript")||e.includes("transcript"))return console.log("Found transcript button, clicking..."),n.click(),void setTimeout(()=>t(!0),2e3)}console.log("Transcript button not found"),t(!1)})}())return void console.log("Could not open transcript panel - video may not have transcript");const c=await async function(){try{await new Promise(t=>setTimeout(t,1e3));const t=[],e=document.querySelectorAll("ytd-transcript-segment-renderer");return console.log("Found transcript items:",e.length),0===e.length?(console.log("No transcript items found in panel"),null):(e.forEach(e=>{const n=e.querySelector(".segment-timestamp"),o=e.querySelector(".segment-text");if(n&&o){const e=n.textContent?.trim()||"0:00",r=o.textContent?.trim()||"",s=e.split(":").map(Number);let i=0;2===s.length?i=60*s[0]+s[1]:3===s.length&&(i=3600*s[0]+60*s[1]+s[2]),t.push({text:r,start:i,duration:0})}}),t.length>0?t:null)}catch(t){return console.error("Error extracting transcript from panel:",t),null}}();if(!c||0===c.length)return void console.log("Could not extract transcript from panel");console.log("Submitting transcript...",{videoId:o,segments:c.length});const a=await async function(e,n){try{return(await fetch(`${t}/api/videos/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({video:e,transcript:n})})).ok}catch(t){return console.error("Error submitting transcript:",t),!1}}(i,c);a&&(console.log("Transcript submitted successfully"),n(!0),setTimeout(()=>n(!1),3e3))}let r=null,s=!1,i=!1;async function c(){const t=e();t&&t!==r&&!s&&(console.log("New video detected:",t),r=t,s=!0,await o(),s=!1)}window.addEventListener("yt-navigate-finish",()=>{i&&(console.log("YouTube navigation detected"),setTimeout(c,1e3))}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{r=e(),o(),i=!0},3e3)}):setTimeout(()=>{r=e(),o(),i=!0},3e3)})();
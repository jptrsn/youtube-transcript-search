(()=>{"use strict";const t="https://ytscri.be";function n(){return new URLSearchParams(window.location.search).get("v")}function e(t){chrome.runtime.sendMessage({type:"UPDATE_ICON",success:t})}async function o(){const o=n();if(!o)return;console.log("Processing video:",o);const r=await async function(n){try{const e=await fetch(`${t}/api/videos/${n}/exists`),o=await e.json();return{exists:!0===o.exists,hasTranscript:!0===o.has_transcript}}catch(t){return console.error("Error checking video status:",t),{exists:!1,hasTranscript:!1}}}(o);if(r.exists&&r.hasTranscript)return void console.log("Video already has transcript in database");r.exists&&!r.hasTranscript?console.log("Video exists but missing transcript, fetching..."):console.log("New video, fetching transcript...");const s=function(){try{const t=document.querySelectorAll("script");for(const n of t){const t=n.textContent||"";if(t.includes("ytInitialData")){const n=t.match(/"channelId":"([^"]+)"/);if(n)return n[1]}}}catch(t){console.error("Error extracting channel ID:",t)}return null}();if(!s)return void console.log("Could not extract channel ID");const c=function(t,n){try{const e=document.querySelectorAll("script");for(const o of e){const e=o.textContent||"";if(e.includes("ytInitialPlayerResponse")){const o=e.match(/ytInitialPlayerResponse\s*=\s*({.+?});/);if(o){const e=JSON.parse(o[1]).videoDetails;return{videoId:t,channelId:n,title:e.title,description:e.shortDescription||"",publishedAt:(new Date).toISOString(),thumbnailUrl:e.thumbnail?.thumbnails?.[0]?.url||""}}}}}catch(t){console.error("Error extracting video info:",t)}return null}(o,s);if(!c)return void console.log("Could not extract video info");let i=await async function(t){try{console.log("Attempting to fetch transcript silently via API...");const n=function(){try{const t=document.querySelectorAll("script");for(const n of t){const t=(n.textContent||"").match(/"INNERTUBE_API_KEY":\s*"([a-zA-Z0-9_-]+)"/);if(t)return console.log("Found InnerTube API key"),t[1]}return console.log("No InnerTube API key found in page scripts"),null}catch(t){return console.error("Error extracting API key:",t),null}}();if(!n)return console.log("Could not extract API key, falling back to UI method"),null;const e=await async function(t,n){try{const e=`https://www.youtube.com/youtubei/v1/player?key=${n}`,o={context:{client:{clientName:"WEB",clientVersion:"2.20241212.01.00"}},videoId:t};console.log("Fetching captions from InnerTube API...");const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(console.log("InnerTube API response status:",r.status),!r.ok){const t=await r.text();return console.error("InnerTube API request failed:",r.status),console.error("Error response:",t),null}const s=await r.json(),c=s?.captions?.playerCaptionsTracklistRenderer;return c&&c.captionTracks?(console.log("Found caption tracks:",c.captionTracks.length),c):(console.log("No captions available for video"),null)}catch(t){return console.error("Error fetching captions JSON:",t),null}}(t,n);if(!e)return console.log("Could not fetch captions JSON, falling back to UI method"),null;const o=function(t){try{const n=t.captionTracks,e=["en","en-US","en-GB"];for(const t of e){const e=n.find(n=>n.languageCode===t&&"asr"!==n.kind);if(e)return console.log("Found manual English transcript"),e.baseUrl}for(const t of e){const e=n.find(n=>n.languageCode===t&&"asr"===n.kind);if(e)return console.log("Found auto-generated English transcript"),e.baseUrl}return console.log("No English transcript found"),null}catch(t){return console.error("Error finding English transcript URL:",t),null}}(e);if(!o)return console.log("No English transcript available, falling back to UI method"),null;const r=await async function(t){try{const n=await fetch(t);if(!n.ok)return console.error("Failed to fetch transcript XML:",n.status),null;const e=await n.text(),o=(new DOMParser).parseFromString(e,"text/xml"),r=o.querySelector("parsererror");if(r)return console.error("XML parsing error:",r.textContent),null;const s=o.querySelectorAll("text"),c=[];return s.forEach(t=>{const n=t.textContent||"",e=parseFloat(t.getAttribute("start")||"0"),o=parseFloat(t.getAttribute("dur")||"0");n&&c.push({text:n,start:e,duration:o})}),console.log(`Parsed ${c.length} transcript segments`),c.length>0?c:null}catch(t){return console.error("Error fetching/parsing transcript:",t),null}}(o);return r?(console.log("Successfully fetched transcript silently!"),r):(console.log("Could not parse transcript, falling back to UI method"),null)}catch(t){return console.error("Silent transcript fetch failed:",t),null}}(o);if(i||(console.log("Silent method failed, trying UI method..."),i=await async function(){if(console.log("Attempting to fetch transcript via UI method..."),!await async function(){return new Promise(t=>{const n=document.querySelectorAll("button");for(const e of n){const n=e.textContent?.toLowerCase()||"";if(n.includes("show transcript")||n.includes("transcript"))return console.log("Found transcript button, clicking..."),e.click(),void setTimeout(()=>t(!0),2e3)}console.log("Transcript button not found"),t(!1)})}())return console.log("Could not open transcript panel - video may not have transcript"),null;const t=await async function(){try{await new Promise(t=>setTimeout(t,1e3));const t=[],n=document.querySelectorAll("ytd-transcript-segment-renderer");return console.log("Found transcript items:",n.length),0===n.length?(console.log("No transcript items found in panel"),null):(n.forEach(n=>{const e=n.querySelector(".segment-timestamp"),o=n.querySelector(".segment-text");if(e&&o){const n=e.textContent?.trim()||"0:00",r=o.textContent?.trim()||"",s=n.split(":").map(Number);let c=0;2===s.length?c=60*s[0]+s[1]:3===s.length&&(c=3600*s[0]+60*s[1]+s[2]),t.push({text:r,start:c,duration:0})}}),t.length>0?t:null)}catch(t){return console.error("Error extracting transcript from panel:",t),null}}();return t&&0!==t.length?(console.log("Successfully fetched transcript via UI method"),t):(console.log("Could not extract transcript from panel"),null)}()),!i||0===i.length)return void console.log("Could not fetch transcript via any method");console.log("Submitting transcript...",{videoId:o,segments:i.length});const l=await async function(n,e){try{return(await fetch(`${t}/api/videos/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({video:n,transcript:e})})).ok}catch(t){return console.error("Error submitting transcript:",t),!1}}(c,i);l&&(console.log("Transcript submitted successfully"),e(!0),setTimeout(()=>e(!1),3e3))}let r=null,s=!1,c=!1;async function i(){const t=n();t&&t!==r&&!s&&(console.log("New video detected:",t),r=t,s=!0,await o(),s=!1)}window.addEventListener("yt-navigate-finish",()=>{c&&(console.log("YouTube navigation detected"),setTimeout(i,1e3))}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{r=n(),o(),c=!0},3e3)}):setTimeout(()=>{r=n(),o(),c=!0},3e3)})();
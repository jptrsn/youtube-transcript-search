(()=>{"use strict";const t="https://ytscri.be";function e(){return new URLSearchParams(window.location.search).get("v")}function n(t){chrome.runtime.sendMessage({type:"UPDATE_ICON",success:t})}async function o(){const o=e();if(!o)return;const r=await async function(e){try{const n=await fetch(`${t}/api/videos/${e}/exists`),o=await n.json();return{exists:!0===o.exists,hasTranscript:!0===o.has_transcript}}catch(t){return console.error("Error checking video status:",t),{exists:!1,hasTranscript:!1}}}(o);if(r.exists&&r.hasTranscript)return void console.log("Video already has transcript in database");r.exists&&!r.hasTranscript?console.log("Video exists but missing transcript, fetching..."):console.log("New video, fetching transcript...");const s=function(){try{const t=document.querySelectorAll("script");for(const e of t){const t=e.textContent||"";if(t.includes("ytInitialData")){const e=t.match(/"channelId":"([^"]+)"/);if(e)return e[1]}}}catch(t){console.error("Error extracting channel ID:",t)}return null}();if(!s)return void console.log("Could not extract channel ID");const c=await async function(t,e){for(let n=0;n<10;n++){try{const n=document.querySelectorAll("script");for(const o of n){const n=o.textContent||"";if(n.includes("ytInitialData")){const o=n.match(/ytInitialData\s*=\s*({.+?});/s);if(o){const n=JSON.parse(o[1]),r=n?.contents?.twoColumnWatchNextResults?.results?.results?.contents?.[0]?.videoPrimaryInfoRenderer;if(r){const o=r.title?.runs?.[0]?.text||"",s=n?.engagementPanels?.find(t=>t.engagementPanelSectionListRenderer?.content?.structuredDescriptionContentRenderer)?.engagementPanelSectionListRenderer?.content?.structuredDescriptionContentRenderer?.items?.[1]?.expandableVideoDescriptionBodyRenderer?.attributedDescriptionBodyText?.content||"",c=`https://i.ytimg.com/vi/${t}/maxresdefault.jpg`;return{videoId:t,channelId:e,title:o,description:s,publishedAt:(new Date).toISOString(),thumbnailUrl:c}}}}}}catch(t){console.log(`Attempt ${n+1} failed:`,t)}await new Promise(t=>setTimeout(t,300))}return console.error("Failed to get video info after 10 attempts"),null}(o,s);if(!c)return void console.log("Could not extract video info");let i=await async function(t){try{const e=function(){try{const t=document.querySelectorAll("script");for(const e of t){const t=(e.textContent||"").match(/"INNERTUBE_API_KEY":\s*"([a-zA-Z0-9_-]+)"/);if(t)return t[1]}return console.log("No InnerTube API key found in page scripts"),null}catch(t){return console.error("Error extracting API key:",t),null}}();if(!e)return console.log("Could not extract API key, falling back to UI method"),null;const n=await async function(t,e){try{const n=`https://www.youtube.com/youtubei/v1/player?key=${e}`,o={context:{client:{clientName:"WEB",clientVersion:"2.20241212.01.00"}},videoId:t},r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!r.ok){const t=await r.text();return console.error("InnerTube API request failed:",r.status),console.error("Error response:",t),null}const s=await r.json(),c=s?.captions?.playerCaptionsTracklistRenderer;return c&&c.captionTracks?c:(console.log("No captions available for video"),null)}catch(t){return console.error("Error fetching captions JSON:",t),null}}(t,e);if(!n)return console.log("Could not fetch captions JSON, falling back to UI method"),null;const o=function(t){try{const e=t.captionTracks,n=["en","en-US","en-GB"];for(const t of n){const n=e.find(e=>e.languageCode===t&&"asr"!==e.kind);if(n)return n.baseUrl}for(const t of n){const n=e.find(e=>e.languageCode===t&&"asr"===e.kind);if(n)return n.baseUrl}return null}catch(t){return console.error("Error finding English transcript URL:",t),null}}(n);return o?await async function(t){try{const e=await fetch(t);if(!e.ok)return console.error("Failed to fetch transcript XML:",e.status),null;const n=await e.text(),o=(new DOMParser).parseFromString(n,"text/xml"),r=o.querySelector("parsererror");if(r)return console.error("XML parsing error:",r.textContent),null;const s=o.querySelectorAll("text"),c=[];return s.forEach(t=>{const e=t.textContent||"",n=parseFloat(t.getAttribute("start")||"0"),o=parseFloat(t.getAttribute("dur")||"0");e&&c.push({text:e,start:n,duration:o})}),c.length>0?c:null}catch(t){return console.error("Error fetching/parsing transcript:",t),null}}(o)||(console.log("Could not parse transcript, falling back to UI method"),null):(console.log("No English transcript available, falling back to UI method"),null)}catch(t){return console.error("Silent transcript fetch failed:",t),null}}(o);if(i||(console.log("Silent method failed, trying UI method..."),i=await async function(){if(!await async function(){return new Promise(t=>{const e=document.querySelectorAll("button");for(const n of e){const e=n.textContent?.toLowerCase()||"";if(e.includes("show transcript")||e.includes("transcript"))return n.click(),void setTimeout(()=>t(!0),2e3)}console.log("Transcript button not found"),t(!1)})}())return console.log("Could not open transcript panel - video may not have transcript"),null;const t=await async function(){try{await new Promise(t=>setTimeout(t,1e3));const t=[],e=document.querySelectorAll("ytd-transcript-segment-renderer");return 0===e.length?null:(e.forEach(e=>{const n=e.querySelector(".segment-timestamp"),o=e.querySelector(".segment-text");if(n&&o){const e=n.textContent?.trim()||"0:00",r=o.textContent?.trim()||"",s=e.split(":").map(Number);let c=0;2===s.length?c=60*s[0]+s[1]:3===s.length&&(c=3600*s[0]+60*s[1]+s[2]),t.push({text:r,start:c,duration:0})}}),t.length>0?t:null)}catch(t){return console.error("Error extracting transcript from panel:",t),null}}();return t&&0!==t.length?t:(console.log("Could not extract transcript from panel"),null)}()),!i||0===i.length)return void console.log("Could not fetch transcript via any method");console.log("Submitting transcript...",{videoId:o,segments:i.length});const a=await async function(e,n){try{return(await fetch(`${t}/api/videos/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({video:e,transcript:n})})).ok}catch(t){return console.error("Error submitting transcript:",t),!1}}(c,i);a&&(console.log("Transcript submitted successfully"),n(!0),setTimeout(()=>n(!1),3e3))}let r=null,s=!1,c=!1;async function i(){const t=e();t&&t!==r&&!s&&(console.log("New video detected:",t),r=t,s=!0,await o(),s=!1)}window.addEventListener("yt-navigate-finish",()=>{c&&(console.log("YouTube navigation detected"),setTimeout(i,1e3))}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{r=e(),o(),c=!0},3e3)}):setTimeout(()=>{r=e(),o(),c=!0},3e3)})();